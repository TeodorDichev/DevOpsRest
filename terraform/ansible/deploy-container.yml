---
- hosts: webservers
  remote_user: ubuntu
  become: yes
  gather_facts: False

  vars:
    docker_image: "ghcr.io/teodordichev/devopsres/devops-demo:latest"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install prerequisites for Docker
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
        state: present

    # Commands from: https://docs.docker.com/engine/install/ubuntu/
    - name: Add Docker GPG key
      shell: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
        state: present

    - name: Install Docker Engine
      apt:
        name: docker-ce
        state: latest
        update_cache: yes

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Pull Docker image from GHCR
      docker_image:
        name: "{{ docker_image }}"
        source: pull

    - name: Run container on port 80
      docker_container:
        name: my_app
        image: "{{ docker_image }}"
        state: started
        restart_policy: always
        published_ports:
          - "80:80"
