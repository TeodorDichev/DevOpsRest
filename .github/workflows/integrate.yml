name: CICD Demo

# Added due to last failure (GPT told me to)
permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - '**'  # Run on all branches
  pull_request:

jobs:
  # No need for lint in my demo

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Set lowercase repository variable
      # - github.repository (inside ${{ }}) cannot be lowercased directly in GitHub Actions expressions.
      #   See discussion: https://github.com/orgs/community/discussions/25768
      # - GITHUB_REPOSITORY is an environment variable available inside shell scripts.
      #   It contains the same value as github.repository, but we can manipulate it with Bash:
      #   https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html
      # - GHCR requires lowercase for owner and repo in image paths. Took me a while to figure out.
      - name: Set lowercase repository
        run: |
          REPO_LOWER=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
          echo "REPOSITORY=$REPO_LOWER" >> $GITHUB_ENV

      - name: Build Docker Image
        run: |
          docker build -t ghcr.io/$REPOSITORY/devops-demo:latest .

      - name: Push Docker Image
        if: github.ref == 'refs/heads/main'
        run: |
          docker push ghcr.io/$REPOSITORY/devops-demo:latest
